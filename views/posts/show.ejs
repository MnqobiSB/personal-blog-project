<% layout('layouts/boilerplate') -%>
<main
	id="main" 
	class="main container"
	tabindex="-1"
	role="main">
  	<div class="row">
    	<div class="col-md-8 blog-main">
      		<section class="single-blog-post">
      			<div class="card mb-3">
      				<% post.images.forEach(function(image){ %>
						<img 
							src="<%= image.url %>" 
							class="card-img-top img-responsive single-blog-post-image" 
							alt="<%= post.title %>'s image" 
				          	title="<%= post.title %>'s image"
				          	loading="lazy"
						>
					<% }) %>
					<div class="card-body">
		      			<article>
		      				<header class="single-article-header">
				        		<h1 class="card-title single-blog-post-title"><%= post.title %></h1>
				        		<p class="single-blog-post-meta">
				        			<%= moment(post.createdAt).format('MMMM DD, YYYY') %> Â· <span class="read text-muted"><%= post.read %> min read</span>
				        		</p>
				        		<strong class="d-inline-block mb-2 text-primary">#<%= post.category %></strong>
							</header>
							<section class="single-article-body">	
			        			<p><%- post.body %></p>
					        </section>
					        <footer class="single-article-footer">
					        	<p><%- post.footer %></p>
					        </footer>
					        <div class="admin-buttons">
					        	<hr>
								<% if (currentUser && post.author.equals(currentUser._id)) { %>
									<a class="float-right" href="/posts/<%= post.id %>/edit">
										<button class="btn btn-sm btn-warning edit-post-btn">
											<i class="fas fa-edit"></i> Edit post
										</button>
									</a>
									<form 
										class="float-right" 
										action="/posts/<%= post.id %>?_method=DELETE" 
										method="POST"
									>
										<button class="btn btn-sm btn-danger delete-post-btn">
											<i class="fas fa-trash"></i> Delete
										</button>
									</form>
								<% } %>
					        	<a href="/">Go Back</a>
					        </div>
				        </article>
			        </div>
		        </div>
      		</section><!-- /.blog-post -->

      		<section class="comments">
	      		<div class="card mb-3">
	      				<h2 class="card-header section-header">Comments</h2>
				  	<div class="card-body comment-card-body">
				  		<% if (currentUser) { %>
							<p class="card-text"><i class="fas fa-pen-alt"></i> Leave a comment</p>
							<form 
								action="/posts/<%= post.id %>/reviews" 
								method="POST" 
								class="post-comment-form"
							>
								<div class="form-group">
									<textarea 
										name="review[body]"
										id="comment" 
										class="form-control" 
										maxlength="1000" 
										pattern="[a-zA-Z\s0-9]{10,}" 
										title="Message can be a series of alphabetic and numeric characters only (min 10, max 1000)."
										rows="4"
										placeholder="Your comment" 
										required 
									></textarea>
								</div>
								<div class="form-group">
									<button class="btn btn-primary submit-comment-btn">
										Submit
									</button>
								</div>
							</form>
							<hr class="comment-underline">
						<% } else { %>
							<p class="card-text">
								<a href="/sign-in?returnTo=true">
									<i class="fas fa-pen-alt"></i> Leave a comment
								</a>
							</p>
						<% } %>
				    	<!-- display all reviews -->
				    	<p class="recent-comments"><i class="fas fa-comments"></i> <strong>Recent Comments</strong></p>
				    	<% if (post.reviews.length === 0) { %>
							<em class="no-comments">No comments yet.</em>
						<% } %>
						<% post.reviews.forEach(function(review) { %>
							<div class="media text-muted">
								<img 
									src="<%= review.author.image.secure_url %>"
									class="mr-2 rounded mt-2 review-author-img" 
									alt="<%= review.author.username %>'s image" 
				          			title="<%= review.author.username %>'s image"
				          			loading="lazy"
									width="32" 
									height="32" 
								/>
						      	<p class="media-body mb-0 lh-125">
						        	<strong class="d-block text-gray-dark username"><%= review.author.username %></strong>
						        	<%= review.body %>
						      	</p>
						      	<span class="pull-right small"><%= moment(review.createdAt).fromNow() %></span>
						    </div>

							<% if (currentUser && review.author.equals(currentUser._id)) { %>
								<div>
									<button class="btn btn-sm btn-warning float-right toggle-edit-form mb-2">Edit</button>
									<form 
										action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=PUT" 
										method="POST" 
										class="edit-comment-form"
									>
										<div class="form-group">
											<textarea 
												name="review[body]"
												id="edit-comment" 
												class="form-control" 
												maxlength="1000" 
												pattern="[a-zA-Z\s0-9]{10,}" 
												title="Message can be a series of alphabetic and numeric characters only (min 10, max 1000)."
												rows="4" 
												required
											><%= review.body %></textarea>
										</div>
										<div class="form-group">
											<button class="btn btn-primary update-comment-btn">
												Update
											</button>
										</div>
									</form>

									<script>
										$('#edit-rate<%= review.rating %>').prop('checked', true);
									</script>

									<form 
										action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=DELETE" 
										method="POST"
										class="float-right"
									>
										<button class="btn btn-sm btn-danger delete-comment-btn">
											Delete
										</button>
									</form>
								</div>
							<% }; %>
							<hr>
						<% }); %>
				  	</div>
				</div>
			</section>

			<section class="related-posts">
				<div class="card">
					<h2 class="card-header section-header">Also Check Out</h2>
					<div class="card-body">
						<% relatedPosts.forEach(function(relatedPost){ %>
							<div class="card mb-3" style="max-width: 640px;">
							  	<div class="row no-gutters">
							    	<div class="col-md-4">
							    		<% relatedPost.images.forEach(function(image){ %>
											<img 
												src="<%= image.url %>" 
												class="card-img img-responsive related-post-image" 
												alt="<%= relatedPost.title %>'s image" 
									          	title="<%= relatedPost.title %>'s image"
									          	loading="lazy"
											>
										<% }) %>
							    	</div>
							    	<div class="col-md-8">
							      		<div class="card-body">
							        		<h3 class="card-title section-sub__header"><%= relatedPost.title %></h3>
							        		<p class="card-text float-right"><span class="read text-muted"><%= post.read %> min read</span></p>
							        		<p class="card-text"><a href="/posts/<%= relatedPost.id %>" class="stretched-link">Read Now</a></p>
							      		</div>
							    	</div>
							  	</div>
							</div>
						<% }); %>
					</div>
				</div>
			</section>
    	</div><!-- /.blog-main -->

    	<aside class="col-md-4 blog-sidebar">
    		<% include ../partials/sidebar %>	
    	</aside><!-- /.blog-sidebar -->
  	</div><!-- /.row -->
</main><!-- /.container -->

