<% layout('layouts/boilerplate') -%>
<main
	id="main" 
	class="main container"
	tabindex="-1"
	role="main">
  	<div class="row">
    	<div class="col-md-8 blog-main">
      		<div class="single-blog-post">
      			<div class="card mb-3">
      				<% post.images.forEach(function(image){ %>
						<img 
							src="<%= image.url %>" 
							class="card-img-top img-responsive single-blog-post-image" 
							alt="<%= post.title %>'s image" 
				          	title="<%= post.title %>'s image"
						>
					<% }) %>
					<div class="card-body">
		      			<article>
		      				<header class="single-blog-post-header">
				        		<h1 class="card-title single-blog-post-title"><%= post.title %></h1>
				        		<p class="single-blog-post-meta"><%= moment(post.createdAt).format('MMMM DD, YYYY') %></p>
				        		<strong class="d-inline-block mb-2 text-primary">#<%= post.category %></strong>
				        		<p class="read text-muted"><%= post.read %> min read</p>
							</header>
							<section class="single-blog-post-body">	
			        			<p><%- post.body %></p>
					        </section>
					        <section>
					        	<p><%- post.footer %></p>
					        </section>
					        <footer class="single-blog-post-footer">
					        	<hr>
								<% if (currentUser && post.author.equals(currentUser._id)) { %>
									<a class="float-right" href="/posts/<%= post.id %>/edit">
										<button class="btn-sm edit-post-btn">
											<i class="fas fa-edit"></i> Edit post
										</button>
									</a>
									<form 
										class="float-right" 
										action="/posts/<%= post.id %>?_method=DELETE" 
										method="POST"
									>
										<button class="delete-post-btn btn-sm">
											<i class="fas fa-trash"></i> Delete
										</button>
									</form>
								<% } %>
					        	<a href="/">Go Back</a>
					        </footer>
				        </article>
			        </div>
		        </div>
      		</div><!-- /.blog-post -->
      		<div class="card">
			  	<h2 class="card-header comment-card-header">Comments</h2>
			  	<div class="card-body comment-card-body">
			  		<% if (currentUser) { %>
						<p class="card-text">Leave a comment</p>
						<form action="/posts/<%= post.id %>/reviews" method="POST">
							<div class="form-group">
								<textarea 
									name="review[body]"
									id="comment" 
									class="form-control" 
									maxlength="1000" 
									pattern="[a-zA-Z\s0-9]{10,}" 
									title="Message can be a series of alphabetic and numeric characters only (min 10, max 1000)."
									rows="4"
									placeholder="Your comment" 
									required 
								></textarea>
							</div>
							<input type="submit">
						</form>
					<% } else { %>
						<p class="card-text"><a href="/sign-in?returnTo=true">Create a review</a></p>
					<% } %>
			    	<!-- display all reviews -->
					<% post.reviews.forEach(function(review) { %>
						<div>
							Author: <%= review.author.username %> <br>
							<%= review.body %> <br>
							Rating: <%= review.rating %>
						</div>
						<% if (currentUser && review.author.equals(currentUser._id)) { %>
							<div>
								<button class="toggle-edit-form">Edit</button>

								<form action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=PUT" method="POST" class="edit-review-form">
									<textarea name="review[body]" required><%= review.body %></textarea>
									<input type="submit" value="Update">
								</form>

								<script>
									$('#edit-rate<%= review.rating %>').prop('checked', true);
								</script>

								<form action="/posts/<%= post.id %>/reviews/<%= review.id %>?_method=DELETE" method="POST">
									<input type="submit" value="Delete">
								</form>
							</div>
						<% }; %>
						<hr>
					<% }); %>
			  	</div>
			</div>
    	</div><!-- /.blog-main -->

    	<aside class="col-md-4 blog-sidebar">
    		<% include ../partials/sidebar %>	
    	</aside><!-- /.blog-sidebar -->
  	</div><!-- /.row -->
</main><!-- /.container -->

